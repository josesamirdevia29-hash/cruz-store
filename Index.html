<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Sistema Financiero - Cruz Store</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 14px;
            }
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .tabs {
                padding: 0 5px;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 14px;
            }
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            background: white;
        }
        
        .content {
            padding: 30px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }
        }
        
        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .card {
                padding: 20px;
            }
        }
        
        .card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .card .amount {
            font-size: 32px;
            font-weight: bold;
        }

        .card .comparison {
            font-size: 13px;
            margin-top: 8px;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .card h3 {
                font-size: 13px;
            }
            
            .card .amount {
                font-size: 26px;
            }
            
            .card .comparison {
                font-size: 12px;
            }
        }
        
        .filter-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar label {
            font-weight: 600;
            color: #495057;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .filter-bar {
                padding: 15px;
                gap: 10px;
                margin-bottom: 20px;
            }
            
            .filter-bar label {
                width: 100%;
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            .filter-buttons {
                width: 100%;
                gap: 6px;
            }
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .filter-btn {
                padding: 8px 12px;
                font-size: 12px;
                flex: 1;
                min-width: calc(50% - 3px);
            }
        }

        .date-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-inputs input, .date-inputs select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .date-inputs {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }
            
            .date-inputs input, 
            .date-inputs select {
                width: 100%;
                font-size: 13px;
            }
            
            .date-inputs span {
                display: none;
            }
            
            .date-inputs .btn {
                width: 100%;
            }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Estilo especial para campos de monto */
        input[type="text"]#cajaMonto,
        input[type="text"]#cobrarMonto,
        input[type="text"]#pagarMonto {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: 600;
            color: #11998e;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            letter-spacing: 0.5px;
        }

        input[type="text"]#cajaMonto::placeholder,
        input[type="text"]#cobrarMonto::placeholder,
        input[type="text"]#pagarMonto::placeholder {
            color: #a0aec0;
            font-weight: 400;
        }

        @media (max-width: 768px) {
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px;
                font-size: 14px;
            }
            
            form {
                padding: 20px 15px !important;
            }
            
            h2, h3 {
                font-size: 1.3em !important;
            }
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .btn {
                padding: 12px 20px;
                font-size: 14px;
                width: 100%;
            }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            border-radius: 8px;
            margin-right: 5px;
        }

        .btn-whatsapp:hover {
            background: #128C7E;
        }

        @media (max-width: 768px) {
            .btn-info,
            .btn-warning,
            .btn-danger,
            .btn-whatsapp {
                padding: 8px 10px;
                font-size: 12px;
                margin-bottom: 5px;
            }
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .table-container {
                margin-top: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            table {
                font-size: 13px;
            }
            
            th, td {
                padding: 10px 8px;
                white-space: nowrap;
            }
            
            th {
                position: sticky;
                top: 0;
                z-index: 10;
            }
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pendiente {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-pagado {
            background: #d4edda;
            color: #155724;
        }
        
        .ingreso {
            color: #28a745;
            font-weight: 600;
        }
        
        .egreso {
            color: #dc3545;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .empty-state {
                padding: 40px 15px;
                font-size: 14px;
            }
            
            /* Mejorar visualizaci√≥n de badges en m√≥vil */
            .status-badge {
                font-size: 11px;
                padding: 4px 10px;
            }
            
            /* Scroll suave en tabs */
            .tabs::-webkit-scrollbar {
                height: 4px;
            }
            
            .tabs::-webkit-scrollbar-track {
                background: #f1f1f1;
            }
            
            .tabs::-webkit-scrollbar-thumb {
                background: #667eea;
                border-radius: 4px;
            }
            
            /* Mejorar scroll en tablas */
            .table-container::-webkit-scrollbar {
                height: 6px;
            }
            
            .table-container::-webkit-scrollbar-track {
                background: #f1f1f1;
            }
            
            .table-container::-webkit-scrollbar-thumb {
                background: #667eea;
                border-radius: 3px;
            }
            
            /* Agregar indicador de que hay m√°s contenido en tablas */
            .table-container::after {
                content: '‚Üê Desliza para ver m√°s ‚Üí';
                display: block;
                text-align: center;
                padding: 10px;
                font-size: 12px;
                color: #6c757d;
                background: #f8f9fa;
                border-top: 1px solid #dee2e6;
            }
            
            /* Ocultar indicador si no hay scroll */
            .table-container[data-scrollable="false"]::after {
                display: none;
            }
        }

        .comparison-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .comparison-section h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .comparison-section {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .comparison-section h3 {
                font-size: 16px;
                margin-bottom: 10px;
            }
            
            .comparison-section > div:first-child {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 10px;
            }
            
            .comparison-section .date-inputs {
                width: 100%;
            }
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .comparison-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .comparison-item .label {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .comparison-item .value {
            font-size: 20px;
            font-weight: bold;
            color: #495057;
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .comparison-item {
                padding: 12px;
            }
            
            .comparison-item .label {
                font-size: 12px;
            }
            
            .comparison-item .value {
                font-size: 18px;
            }
        }

        .trend {
            font-size: 12px;
            margin-top: 5px;
        }

        .trend.up {
            color: #28a745;
        }

        .trend.down {
            color: #dc3545;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .action-buttons button,
            .action-buttons a {
                width: 100%;
                text-align: center;
                margin: 0;
            }
        }

        /* Estilos para gr√°ficos */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 18px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.large {
            height: 400px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 20px;
            }
            
            .chart-card {
                padding: 15px;
                border-radius: 12px;
            }
            
            .chart-card h3 {
                font-size: 16px;
                margin-bottom: 15px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .chart-container.large {
                height: 300px;
            }
        }

        /* Estilos para controles de sincronizaci√≥n */
        .sync-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .sync-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .sync-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .sync-btn:active {
            transform: translateY(0);
        }

        .sync-status {
            color: rgba(255,255,255,0.9);
            font-size: 13px;
            margin-top: 10px;
            font-style: italic;
        }

        /* Animaciones para notificaciones */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .sync-controls {
                gap: 8px;
            }
            
            .sync-btn {
                padding: 8px 15px;
                font-size: 13px;
            }
            
            .sync-status {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíé CRUZ STORE</h1>
            <p>Sistema de Control Financiero</p>
            <div class="sync-controls">
                <button class="sync-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="cargarDatosDesdeGoogleSheets()">üì• Cargar Datos</button>
                <button class="sync-btn" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);" onclick="guardarDatosEnGoogleSheets()">üíæ Guardar Ahora</button>
                <button id="btnToggleSync" class="sync-btn" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);" onclick="toggleSincronizacion()">üîÑ Sincronizaci√≥n: ON</button>
            </div>
            <div id="estadoSincronizacion" class="sync-status">Esperando sincronizaci√≥n...</div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('graficos')">üìà Gr√°ficos</button>
            <button class="tab" onclick="showTab('caja')">üí∞ Caja</button>
            <button class="tab" onclick="showTab('cobrar')">üë• Cuentas por Cobrar</button>
            <button class="tab" onclick="showTab('pagar')">üè™ Cuentas por Pagar</button>
            <button class="tab" onclick="showTab('ingresos')">üíµ Ingresos</button>
            <button class="tab" onclick="showTab('gastos')">üìù Gastos</button>
            <button class="tab" onclick="showTab('historial')">üìã Historial</button>
        </div>
        
        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboard" class="tab-content active">
                <div class="filter-bar">
                    <label>üìÖ Per√≠odo:</label>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="setFilter('mes_actual')">Este mes</button>
                        <button class="filter-btn" onclick="setFilter('mes_pasado')">Mes pasado</button>
                        <button class="filter-btn" onclick="setFilter('ultimos_3')">√öltimos 3 meses</button>
                        <button class="filter-btn" onclick="setFilter('este_ano')">Este a√±o</button>
                        <button class="filter-btn" onclick="setFilter('todo')">Todo</button>
                        <button class="filter-btn" onclick="setFilter('personalizado')">Personalizado</button>
                    </div>
                    <div id="customDateRange" style="display: none;" class="date-inputs">
                        <input type="date" id="fechaDesde">
                        <span>hasta</span>
                        <input type="date" id="fechaHasta">
                        <button class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;" onclick="aplicarFiltroPersonalizado()">Aplicar</button>
                    </div>
                </div>

                <div class="dashboard">
                    <div class="card">
                        <h3>üíµ DINERO DISPONIBLE</h3>
                        <div class="amount" id="dineroDisponible">$0</div>
                        <div class="comparison" id="compDinero"></div>
                    </div>
                    <div class="card success">
                        <h3>üì• ME DEBEN (Por Cobrar)</h3>
                        <div class="amount" id="porCobrar">$0</div>
                        <div class="comparison" id="compCobrar"></div>
                    </div>
                    <div class="card warning">
                        <h3>üì§ DEBO (Por Pagar)</h3>
                        <div class="amount" id="porPagar">$0</div>
                        <div class="comparison" id="compPagar"></div>
                    </div>
                    <div class="card info">
                        <h3>üíé CAPITAL TOTAL</h3>
                        <div class="amount" id="capitalTotal">$0</div>
                        <div class="comparison" id="compCapital"></div>
                    </div>
                </div>

                <!-- Nuevas cards de Balance -->
                <div class="dashboard" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                    <div class="card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                        <h3>üìä BALANCE OPERACIONAL</h3>
                        <div class="amount" id="balanceOperacional">$0</div>
                        <div class="comparison" style="font-size: 12px;">Rentabilidad del negocio (sin gastos personales)</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h3>üí∞ BALANCE GENERAL</h3>
                        <div class="amount" id="balanceGeneral">$0</div>
                        <div class="comparison" style="font-size: 12px;">Balance real (incluye gastos personales)</div>
                    </div>
                </div>

                <!-- Gr√°fico de Gastos Personales vs Ingresos -->
                <div class="chart-card" style="margin-bottom: 30px;">
                    <h3>üè¶ Gastos Personales vs Ingresos del Negocio</h3>
                    <div class="chart-container">
                        <canvas id="chartGastosPersonales"></canvas>
                    </div>
                </div>

                <div class="comparison-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h3 style="margin: 0;">üìä Comparativa de Per√≠odos</h3>
                        <div class="date-inputs" style="flex-shrink: 0;">
                            <label style="font-size: 14px;">Comparar con:</label>
                            <select id="periodoComparacion" onchange="actualizarDashboard()" style="padding: 6px 10px;">
                                <option value="periodo_anterior">Per√≠odo anterior</option>
                                <option value="mes_pasado">Mes pasado</option>
                                <option value="mismo_periodo_ano_anterior">Mismo per√≠odo a√±o anterior</option>
                                <option value="personalizado">Rango personalizado</option>
                            </select>
                            <div id="rangoComparacion" style="display: none;">
                                <input type="date" id="fechaDesdeComp" style="padding: 6px 10px;">
                                <span>hasta</span>
                                <input type="date" id="fechaHastaComp" style="padding: 6px 10px;">
                            </div>
                        </div>
                    </div>
                    <div class="comparison-grid">
                        <div class="comparison-item">
                            <div class="label">Ingresos operacionales del per√≠odo</div>
                            <div class="value ingreso" id="ingresosActual">$0</div>
                            <div class="trend" id="trendIngresos"></div>
                        </div>
                        <div class="comparison-item">
                            <div class="label">Egresos operacionales del per√≠odo</div>
                            <div class="value egreso" id="egresosActual">$0</div>
                            <div class="trend" id="trendEgresos"></div>
                        </div>
                        <div class="comparison-item">
                            <div class="label">Balance operacional del per√≠odo</div>
                            <div class="value" id="balanceActual">$0</div>
                            <div class="trend" id="trendBalance"></div>
                        </div>
                        <div class="comparison-item">
                            <div class="label">Promedio diario de ingresos</div>
                            <div class="value" id="promedioDiario">$0</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px;">üìã Resumen Detallado</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Concepto</th>
                                <th>Per√≠odo Actual</th>
                                <th>Per√≠odo de Comparaci√≥n</th>
                                <th>Cambio</th>
                            </tr>
                        </thead>
                        <tbody id="resumenDetallado">
                            <tr><td colspan="4" class="empty-state">No hay movimientos</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- GR√ÅFICOS -->
            <div id="graficos" class="tab-content">
                <h2 style="margin-bottom: 20px;">üìà An√°lisis Visual de Finanzas</h2>

                <div class="filter-bar">
                    <label>üìÖ Per√≠odo:</label>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="setFilterGraficos('mes_actual')">Este mes</button>
                        <button class="filter-btn" onclick="setFilterGraficos('mes_pasado')">Mes pasado</button>
                        <button class="filter-btn" onclick="setFilterGraficos('ultimos_3')">√öltimos 3 meses</button>
                        <button class="filter-btn" onclick="setFilterGraficos('este_ano')">Este a√±o</button>
                        <button class="filter-btn" onclick="setFilterGraficos('todo')">Todo</button>
                    </div>
                </div>

                <div class="charts-grid">
                    <!-- Distribuci√≥n de Capital -->
                    <div class="chart-card">
                        <h3>üíé Distribuci√≥n de Capital</h3>
                        <div class="chart-container">
                            <canvas id="chartCapital"></canvas>
                        </div>
                    </div>

                    <!-- Composici√≥n Financiera -->
                    <div class="chart-card">
                        <h3>üí∞ Composici√≥n Financiera</h3>
                        <div class="chart-container">
                            <canvas id="chartComposicion"></canvas>
                        </div>
                    </div>

                    <!-- Ingresos por Categor√≠a -->
                    <div class="chart-card">
                        <h3>üíµ Ingresos por Categor√≠a</h3>
                        <div class="chart-container">
                            <canvas id="chartIngresos"></canvas>
                        </div>
                    </div>

                    <!-- Gastos por Categor√≠a -->
                    <div class="chart-card">
                        <h3>üìä Gastos por Categor√≠a</h3>
                        <div class="chart-container">
                            <canvas id="chartGastos"></canvas>
                        </div>
                    </div>

                    <!-- Ingresos vs Egresos -->
                    <div class="chart-card">
                        <h3>üìà Ingresos vs Egresos</h3>
                        <div class="chart-container">
                            <canvas id="chartIngresosEgresos"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Evoluci√≥n Mensual -->
                <div class="chart-card">
                    <h3>üìä Evoluci√≥n Mensual (√öltimos 6 meses)</h3>
                    <div class="chart-container large">
                        <canvas id="chartEvolucion"></canvas>
                    </div>
                </div>

                <!-- Estado de Cuentas -->
                <div class="charts-grid" style="margin-top: 25px;">
                    <div class="chart-card">
                        <h3>üë• Estado de Cuentas por Cobrar</h3>
                        <div class="chart-container">
                            <canvas id="chartCobrar"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3>üè™ Estado de Cuentas por Pagar</h3>
                        <div class="chart-container">
                            <canvas id="chartPagar"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CAJA -->
            <div id="caja" class="tab-content">
                <h2 style="margin-bottom: 20px;">üí∞ Registro de Caja</h2>
                
                <form onsubmit="agregarMovimientoCaja(event)" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="cajafecha" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="cajaTipo" required onchange="actualizarCategorias()">
                                <option value="Ingreso">üí∞ Ingreso</option>
                                <option value="Egreso">üì§ Egreso</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Monto</label>
                            <input type="text" id="cajaMonto" placeholder="50.000" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Concepto</label>
                        <input type="text" id="cajaConcepto" placeholder="Ej: Venta de collar, Compra de materiales" required>
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select id="cajaCategoria" required>
                            <!-- Las opciones se cargar√°n din√°micamente seg√∫n el tipo -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notas (opcional)</label>
                        <textarea id="cajaNotas" rows="2" placeholder="Agrega detalles adicionales..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">‚úÖ Agregar Movimiento</button>
                </form>

                <div class="filter-bar">
                    <label>üîç Filtrar por:</label>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="setFilterCaja('todo')">Todo</button>
                        <button class="filter-btn" onclick="setFilterCaja('mes_actual')">Este mes</button>
                        <button class="filter-btn" onclick="setFilterCaja('mes_pasado')">Mes pasado</button>
                        <button class="filter-btn" onclick="setFilterCaja('personalizado')">Rango</button>
                    </div>
                    <div id="customDateRangeCaja" style="display: none;" class="date-inputs">
                        <input type="date" id="fechaDesdeCaja">
                        <span>hasta</span>
                        <input type="date" id="fechaHastaCaja">
                        <button class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;" onclick="aplicarFiltroCaja()">Aplicar</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Concepto</th>
                                <th>Categor√≠a</th>
                                <th>Monto</th>
                                <th>Notas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCaja">
                            <tr><td colspan="7" class="empty-state">No hay movimientos registrados</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- CUENTAS POR COBRAR -->
            <div id="cobrar" class="tab-content">
                <h2 style="margin-bottom: 20px;">üë• Cuentas por Cobrar</h2>
                
                <form onsubmit="agregarCuentaPorCobrar(event)" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cliente</label>
                            <input type="text" id="cobrarCliente" placeholder="Nombre del cliente" required>
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono (WhatsApp)</label>
                            <input type="tel" id="cobrarTelefono" placeholder="3001234567" pattern="[0-9]{10}" title="Ingresa un n√∫mero de 10 d√≠gitos">
                        </div>
                        <div class="form-group">
                            <label>Fecha de Venta</label>
                            <input type="date" id="cobrarFecha" required>
                        </div>
                        <div class="form-group">
                            <label>Total Deuda</label>
                            <input type="text" id="cobrarMonto" placeholder="200.000" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea id="cobrarNotas" rows="2" placeholder="Detalles de la venta, producto, etc."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">‚úÖ Agregar Cliente</button>
                </form>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Tel√©fono</th>
                                <th>Fecha Venta</th>
                                <th>Total Deuda</th>
                                <th>Abonos</th>
                                <th>Saldo Pendiente</th>
                                <th>Estado</th>
                                <th>Notas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCobrar">
                            <tr><td colspan="9" class="empty-state">No hay cuentas por cobrar</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- CUENTAS POR PAGAR -->
            <div id="pagar" class="tab-content">
                <h2 style="margin-bottom: 20px;">üè™ Cuentas por Pagar</h2>
                
                <form onsubmit="agregarCuentaPorPagar(event)" style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Proveedor</label>
                            <input type="text" id="pagarProveedor" placeholder="Nombre del proveedor" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Compra</label>
                            <input type="date" id="pagarFecha" required>
                        </div>
                        <div class="form-group">
                            <label>Total Deuda</label>
                            <input type="text" id="pagarMonto" placeholder="150.000" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea id="pagarNotas" rows="2" placeholder="Detalles de la compra, materiales, etc."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">‚úÖ Agregar Proveedor</button>
                </form>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Proveedor</th>
                                <th>Fecha Compra</th>
                                <th>Total Deuda</th>
                                <th>Pagos</th>
                                <th>Saldo Pendiente</th>
                                <th>Estado</th>
                                <th>Notas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPagar">
                            <tr><td colspan="8" class="empty-state">No hay cuentas por pagar</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- INGRESOS -->
            <div id="ingresos" class="tab-content">
                <h2 style="margin-bottom: 20px;">üíµ Resumen de Todos los Ingresos por Categor√≠a</h2>

                <div class="filter-bar">
                    <label>üìÖ Per√≠odo:</label>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="setFilterIngresos('mes_actual')">Este mes</button>
                        <button class="filter-btn" onclick="setFilterIngresos('mes_pasado')">Mes pasado</button>
                        <button class="filter-btn" onclick="setFilterIngresos('ultimos_3')">√öltimos 3 meses</button>
                        <button class="filter-btn" onclick="setFilterIngresos('todo')">Todo</button>
                    </div>
                </div>

                <div id="resumenIngresos" class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Categor√≠a</th>
                                <th>Total Ingresado</th>
                                <th>% del Total</th>
                            </tr>
                        </thead>
                        <tbody id="tablaIngresos">
                            <tr><td colspan="3" class="empty-state">No hay ingresos registrados</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- GASTOS -->
            <div id="gastos" class="tab-content">
                <h2 style="margin-bottom: 20px;">üìù Resumen de Todos los Gastos por Categor√≠a</h2>

                <div class="filter-bar">
                    <label>üìÖ Per√≠odo:</label>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="setFilterGastos('mes_actual')">Este mes</button>
                        <button class="filter-btn" onclick="setFilterGastos('mes_pasado')">Mes pasado</button>
                        <button class="filter-btn" onclick="setFilterGastos('ultimos_3')">√öltimos 3 meses</button>
                        <button class="filter-btn" onclick="setFilterGastos('todo')">Todo</button>
                    </div>
                </div>

                <div id="resumenGastos" class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Categor√≠a</th>
                                <th>Total Gastado</th>
                                <th>% del Total</th>
                            </tr>
                        </thead>
                        <tbody id="tablaGastos">
                            <tr><td colspan="3" class="empty-state">No hay gastos registrados</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- HISTORIAL -->
            <div id="historial" class="tab-content">
                <h2 style="margin-bottom: 20px;">üìã Historial Completo de Movimientos</h2>

                <div class="filter-bar">
                    <label>üîç Filtrar por:</label>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="setFilterHistorial('todo')">Todo</button>
                        <button class="filter-btn" onclick="setFilterHistorial('mes_actual')">Este mes</button>
                        <button class="filter-btn" onclick="setFilterHistorial('mes_pasado')">Mes pasado</button>
                        <button class="filter-btn" onclick="setFilterHistorial('personalizado')">Rango</button>
                    </div>
                    <div id="customDateRangeHistorial" style="display: none;" class="date-inputs">
                        <input type="date" id="fechaDesdeHistorial">
                        <span>hasta</span>
                        <input type="date" id="fechaHastaHistorial">
                        <button class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;" onclick="aplicarFiltroHistorial()">Aplicar</button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Concepto</th>
                                <th>Monto</th>
                                <th>Categor√≠a</th>
                                <th>Notas</th>
                            </tr>
                        </thead>
                        <tbody id="tablaHistorial">
                            <tr><td colspan="6" class="empty-state">No hay movimientos en el historial</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURACI√ìN DE GOOGLE SHEETS
        // ========================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzwHcr79Oy6ocCiuwxcdYoBlz2PbAklG_5oFaDiUHJGDP2iJy5_dRlaaZpqKvZCKNet/exec';
        let sincronizacionAutomatica = true;
        let ultimaSincronizacion = null;

        let datos = {
            caja: [],
            cuentasPorCobrar: [],
            cuentasPorPagar: []
        };

        // ========================================
        // FUNCIONES DE SINCRONIZACI√ìN CON GOOGLE SHEETS
        // ========================================
        
        async function cargarDatosDesdeGoogleSheets() {
            try {
                mostrarNotificacion('üì• Cargando datos desde Google Sheets...', 'info');
                
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=cargarTodo&timestamp=${Date.now()}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    datos.caja = result.data.caja || [];
                    datos.cuentasPorCobrar = result.data.cuentasPorCobrar || [];
                    datos.cuentasPorPagar = result.data.cuentasPorPagar || [];
                    
                    // Actualizar todas las vistas
                    actualizarDashboard();
                    actualizarTablaCaja();
                    actualizarTablaCobrar();
                    actualizarTablaPagar();
                    actualizarIngresos();
                    actualizarGastos();
                    actualizarHistorial();
                    actualizarGraficos();
                    
                    ultimaSincronizacion = new Date();
                    actualizarEstadoSincronizacion();
                    mostrarNotificacion('‚úÖ Datos cargados correctamente', 'success');
                } else {
                    mostrarNotificacion('‚ö†Ô∏è No se pudieron cargar los datos', 'warning');
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
                mostrarNotificacion('‚ùå Error al conectar con Google Sheets', 'error');
            }
        }

        async function guardarDatosEnGoogleSheets() {
            try {
                mostrarNotificacion('üíæ Guardando en Google Sheets...', 'info');
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'guardarTodo',
                        caja: datos.caja,
                        cuentasPorCobrar: datos.cuentasPorCobrar,
                        cuentasPorPagar: datos.cuentasPorPagar
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    ultimaSincronizacion = new Date();
                    actualizarEstadoSincronizacion();
                    mostrarNotificacion('‚úÖ Guardado exitosamente', 'success');
                } else {
                    mostrarNotificacion('‚ö†Ô∏è Error al guardar', 'warning');
                }
            } catch (error) {
                console.error('Error al guardar datos:', error);
                mostrarNotificacion('‚ùå Error al guardar en Google Sheets', 'error');
            }
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            // Crear elemento de notificaci√≥n
            const notif = document.createElement('div');
            notif.className = `notificacion notif-${tipo}`;
            notif.textContent = mensaje;
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${tipo === 'success' ? '#11998e' : tipo === 'error' ? '#f5576c' : tipo === 'warning' ? '#f093fb' : '#667eea'};
                color: white;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function actualizarEstadoSincronizacion() {
            const estadoElement = document.getElementById('estadoSincronizacion');
            if (estadoElement && ultimaSincronizacion) {
                const tiempo = formatearTiempoTranscurrido(ultimaSincronizacion);
                estadoElement.textContent = `√öltima sincronizaci√≥n: ${tiempo}`;
            }
        }

        function formatearTiempoTranscurrido(fecha) {
            const ahora = new Date();
            const diff = Math.floor((ahora - fecha) / 1000); // segundos
            
            if (diff < 60) return 'hace un momento';
            if (diff < 3600) return `hace ${Math.floor(diff / 60)} minutos`;
            if (diff < 86400) return `hace ${Math.floor(diff / 3600)} horas`;
            return `hace ${Math.floor(diff / 86400)} d√≠as`;
        }

        function toggleSincronizacion() {
            sincronizacionAutomatica = !sincronizacionAutomatica;
            const btn = document.getElementById('btnToggleSync');
            if (btn) {
                btn.textContent = sincronizacionAutomatica ? 'üîÑ Sincronizaci√≥n: ON' : '‚è∏Ô∏è Sincronizaci√≥n: OFF';
                btn.style.background = sincronizacionAutomatica ? 
                    'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' : 
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            }
            mostrarNotificacion(
                sincronizacionAutomatica ? 'Sincronizaci√≥n autom√°tica activada' : 'Sincronizaci√≥n autom√°tica desactivada',
                sincronizacionAutomatica ? 'success' : 'warning'
            );
        }

        // Guardar autom√°ticamente despu√©s de cada cambio
        function guardarAutomaticamente() {
            if (sincronizacionAutomatica) {
                guardarDatosEnGoogleSheets();
            }
        }

        // Actualizar estado cada minuto
        setInterval(actualizarEstadoSincronizacion, 60000);

        // Cargar datos al iniciar
        window.addEventListener('load', () => {
            cargarDatosDesdeGoogleSheets();
        });

        let filtroActual = 'mes_actual';
        let filtroCaja = 'todo';
        let filtroGastos = 'mes_actual';
        let filtroIngresos = 'mes_actual';
        let filtroHistorial = 'todo';
        let filtroGraficos = 'mes_actual';
        let rangoPersonalizado = null;
        let rangoPersonalizadoCaja = null;
        let rangoPersonalizadoHistorial = null;

        // Variables para almacenar las instancias de los gr√°ficos
        let charts = {};

        // Establecer fecha de hoy por defecto
        document.getElementById('cajafecha').valueAsDate = new Date();
        document.getElementById('cobrarFecha').valueAsDate = new Date();
        document.getElementById('pagarFecha').valueAsDate = new Date();

        // Funci√≥n para formatear n√∫meros con puntos de miles
        function formatearNumero(input) {
            let valor = input.value.replace(/\D/g, ''); // Eliminar todo excepto n√∫meros
            if (valor === '') {
                input.value = '';
                return;
            }
            // Formatear con puntos de miles
            let numeroFormateado = parseInt(valor).toLocaleString('es-CO');
            input.value = numeroFormateado;
        }

        // Funci√≥n para obtener el valor num√©rico sin formato
        function obtenerValorNumerico(input) {
            return parseInt(input.value.replace(/\D/g, '')) || 0;
        }

        // Aplicar formato a los campos de monto
        document.getElementById('cajaMonto').addEventListener('input', function(e) {
            formatearNumero(e.target);
        });

        document.getElementById('cobrarMonto').addEventListener('input', function(e) {
            formatearNumero(e.target);
        });

        document.getElementById('pagarMonto').addEventListener('input', function(e) {
            formatearNumero(e.target);
        });

        // Actualizar placeholders para mostrar el formato
        document.getElementById('cajaMonto').placeholder = '50.000';
        document.getElementById('cobrarMonto').placeholder = '200.000';
        document.getElementById('pagarMonto').placeholder = '150.000';

        // Funci√≥n para actualizar categor√≠as seg√∫n el tipo de movimiento
        function actualizarCategorias() {
            const tipo = document.getElementById('cajaTipo').value;
            const selectCategoria = document.getElementById('cajaCategoria');
            
            let html = '';
            
            if (tipo === 'Ingreso') {
                html = `
                    <optgroup label="üí∞ Capital y Aportes">
                        <option value="Capital Inicial">Capital Inicial</option>
                        <option value="Aporte Personal">Aporte Personal</option>
                        <option value="Pr√©stamo Recibido">Pr√©stamo Recibido</option>
                    </optgroup>
                    <optgroup label="üìà Ingresos del Negocio">
                        <option value="Ventas" selected>Ventas</option>
                    </optgroup>
                    <optgroup label="üìã Otros Ingresos">
                        <option value="Otros">Otros</option>
                    </optgroup>
                `;
            } else {
                html = `
                    <optgroup label="üìâ Gastos del Negocio">
                        <option value="Inventario" selected>Inventario</option>
                        <option value="Publicidad">Publicidad</option>
                        <option value="Env√≠os">Env√≠os</option>
                        <option value="Arriendo">Arriendo</option>
                        <option value="Servicios">Servicios P√∫blicos</option>
                    </optgroup>
                    <optgroup label="üè¶ Gastos Personales">
                        <option value="Retiro Personal">Retiro Personal</option>
                        <option value="Gastos Personales">Gastos Personales</option>
                        <option value="Pago Pr√©stamo">Pago de Pr√©stamo</option>
                    </optgroup>
                    <optgroup label="üìã Otros Gastos">
                        <option value="Otros">Otros</option>
                    </optgroup>
                `;
            }
            
            selectCategoria.innerHTML = html;
        }

        // Inicializar categor√≠as al cargar la p√°gina
        actualizarCategorias();

        // Listener para cambio de per√≠odo de comparaci√≥n
        document.getElementById('periodoComparacion').addEventListener('change', function() {
            if (this.value === 'personalizado') {
                document.getElementById('rangoComparacion').style.display = 'flex';
            } else {
                document.getElementById('rangoComparacion').style.display = 'none';
            }
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Si es la pesta√±a de gr√°ficos, actualizar los gr√°ficos
            if (tabName === 'graficos') {
                actualizarGraficos();
            }
        }

        function formatMoney(amount) {
            return '$' + Number(amount).toLocaleString('es-CO');
        }

        function setFilter(tipo) {
            filtroActual = tipo;
            document.querySelectorAll('#dashboard .filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tipo === 'personalizado') {
                document.getElementById('customDateRange').style.display = 'flex';
            } else {
                document.getElementById('customDateRange').style.display = 'none';
                rangoPersonalizado = null;
                actualizarDashboard();
            }
        }

        function aplicarFiltroPersonalizado() {
            const desde = document.getElementById('fechaDesde').value;
            const hasta = document.getElementById('fechaHasta').value;
            if (desde && hasta) {
                rangoPersonalizado = { desde, hasta };
                actualizarDashboard();
            }
        }

        function setFilterCaja(tipo) {
            filtroCaja = tipo;
            document.querySelectorAll('#caja .filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tipo === 'personalizado') {
                document.getElementById('customDateRangeCaja').style.display = 'flex';
            } else {
                document.getElementById('customDateRangeCaja').style.display = 'none';
                rangoPersonalizadoCaja = null;
                actualizarTablaCaja();
            }
        }

        function aplicarFiltroCaja() {
            const desde = document.getElementById('fechaDesdeCaja').value;
            const hasta = document.getElementById('fechaHastaCaja').value;
            if (desde && hasta) {
                rangoPersonalizadoCaja = { desde, hasta };
                actualizarTablaCaja();
            }
        }

        function setFilterGastos(tipo) {
            filtroGastos = tipo;
            document.querySelectorAll('#gastos .filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            actualizarGastos();
        }

        function setFilterIngresos(tipo) {
            filtroIngresos = tipo;
            document.querySelectorAll('#ingresos .filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            actualizarIngresos();
        }

        function setFilterHistorial(tipo) {
            filtroHistorial = tipo;
            document.querySelectorAll('#historial .filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tipo === 'personalizado') {
                document.getElementById('customDateRangeHistorial').style.display = 'flex';
            } else {
                document.getElementById('customDateRangeHistorial').style.display = 'none';
                rangoPersonalizadoHistorial = null;
                actualizarHistorial();
            }
        }

        function aplicarFiltroHistorial() {
            const desde = document.getElementById('fechaDesdeHistorial').value;
            const hasta = document.getElementById('fechaHastaHistorial').value;
            if (desde && hasta) {
                rangoPersonalizadoHistorial = { desde, hasta };
                actualizarHistorial();
            }
        }

        function setFilterGraficos(tipo) {
            filtroGraficos = tipo;
            document.querySelectorAll('#graficos .filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            actualizarGraficos();
        }

        function obtenerRangoFechas(tipo, rango = null) {
            const hoy = new Date();
            let desde, hasta;

            if (tipo === 'personalizado' && rango) {
                return { desde: new Date(rango.desde), hasta: new Date(rango.hasta) };
            }

            switch(tipo) {
                case 'mes_actual':
                    desde = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                    hasta = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
                    break;
                case 'mes_pasado':
                    desde = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                    hasta = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
                    break;
                case 'ultimos_3':
                    desde = new Date(hoy.getFullYear(), hoy.getMonth() - 2, 1);
                    hasta = hoy;
                    break;
                case 'este_ano':
                    desde = new Date(hoy.getFullYear(), 0, 1);
                    hasta = hoy;
                    break;
                case 'todo':
                    return null;
            }

            return { desde, hasta };
        }

        function filtrarPorFecha(items, tipo, rango = null) {
            const rangoDates = obtenerRangoFechas(tipo, rango);
            if (!rangoDates) return items;

            return items.filter(item => {
                const fecha = new Date(item.fecha);
                return fecha >= rangoDates.desde && fecha <= rangoDates.hasta;
            });
        }

        function obtenerPeriodoComparacion() {
            const tipoComp = document.getElementById('periodoComparacion').value;
            const hoy = new Date();
            const rangoActual = obtenerRangoFechas(filtroActual, rangoPersonalizado);
            
            let desde, hasta;

            if (tipoComp === 'personalizado') {
                const desdeComp = document.getElementById('fechaDesdeComp').value;
                const hastaComp = document.getElementById('fechaHastaComp').value;
                if (desdeComp && hastaComp) {
                    return { desde: new Date(desdeComp), hasta: new Date(hastaComp) };
                }
                return null;
            }

            if (tipoComp === 'periodo_anterior') {
                if (!rangoActual) return null;
                const dias = Math.ceil((rangoActual.hasta - rangoActual.desde) / (1000 * 60 * 60 * 24));
                hasta = new Date(rangoActual.desde);
                hasta.setDate(hasta.getDate() - 1);
                desde = new Date(hasta);
                desde.setDate(desde.getDate() - dias);
                return { desde, hasta };
            }

            if (tipoComp === 'mes_pasado') {
                desde = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                hasta = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
                return { desde, hasta };
            }

            if (tipoComp === 'mismo_periodo_ano_anterior') {
                if (!rangoActual) return null;
                desde = new Date(rangoActual.desde);
                desde.setFullYear(desde.getFullYear() - 1);
                hasta = new Date(rangoActual.hasta);
                hasta.setFullYear(hasta.getFullYear() - 1);
                return { desde, hasta };
            }

            return null;
        }

        function calcularCambio(actual, anterior) {
            if (anterior === 0) return actual > 0 ? '+100%' : '0%';
            const cambio = ((actual - anterior) / anterior) * 100;
            const signo = cambio >= 0 ? '+' : '';
            return signo + cambio.toFixed(1) + '%';
        }

        function actualizarDashboard() {
            // Categor√≠as que NO se consideran ingresos operacionales
            const categoriasCapital = ['Capital Inicial', 'Aporte Personal', 'Pr√©stamo Recibido'];
            const categoriasRetiros = ['Retiro Personal', 'Gastos Personales', 'Pago Pr√©stamo'];
            
            // Datos del per√≠odo actual
            const movimientosFiltrados = filtrarPorFecha(datos.caja, filtroActual, rangoPersonalizado);
            
            let dineroDisponible = datos.caja.reduce((sum, m) => {
                return m.tipo === 'Ingreso' ? sum + m.monto : sum - m.monto;
            }, 0);

            let porCobrar = datos.cuentasPorCobrar.reduce((sum, c) => sum + c.saldoPendiente, 0);
            let porPagar = datos.cuentasPorPagar.reduce((sum, c) => sum + c.saldoPendiente, 0);
            let capitalTotal = dineroDisponible + porCobrar - porPagar;

            // Separar ingresos operacionales de aportes de capital
            const ingresosOperacionales = movimientosFiltrados
                .filter(m => m.tipo === 'Ingreso' && !categoriasCapital.includes(m.categoria))
                .reduce((s, m) => s + m.monto, 0);
            
            const aportesCapital = movimientosFiltrados
                .filter(m => m.tipo === 'Ingreso' && categoriasCapital.includes(m.categoria))
                .reduce((s, m) => s + m.monto, 0);
            
            const ingresos = ingresosOperacionales + aportesCapital; // Total de ingresos (para dinero disponible)
            
            // Separar egresos operacionales de retiros personales
            const egresosOperacionales = movimientosFiltrados
                .filter(m => m.tipo === 'Egreso' && !categoriasRetiros.includes(m.categoria))
                .reduce((s, m) => s + m.monto, 0);
            
            const retirosPersonales = movimientosFiltrados
                .filter(m => m.tipo === 'Egreso' && categoriasRetiros.includes(m.categoria))
                .reduce((s, m) => s + m.monto, 0);
            
            const egresos = egresosOperacionales + retirosPersonales; // Total de egresos
            const balanceOperacional = ingresosOperacionales - egresosOperacionales; // Balance sin capital ni retiros
            const balanceGeneral = ingresos - egresos; // Balance incluyendo TODO

            // Datos del per√≠odo de comparaci√≥n
            const periodoComp = obtenerPeriodoComparacion();
            let ingresosAnt = 0, egresosAnt = 0, ingresosOpAnt = 0, egresosOpAnt = 0;
            
            if (periodoComp) {
                const movimientosAnt = datos.caja.filter(m => {
                    const fecha = new Date(m.fecha);
                    return fecha >= periodoComp.desde && fecha <= periodoComp.hasta;
                });
                
                ingresosOpAnt = movimientosAnt
                    .filter(m => m.tipo === 'Ingreso' && !categoriasCapital.includes(m.categoria))
                    .reduce((s, m) => s + m.monto, 0);
                
                egresosOpAnt = movimientosAnt
                    .filter(m => m.tipo === 'Egreso' && !categoriasRetiros.includes(m.categoria))
                    .reduce((s, m) => s + m.monto, 0);
                
                ingresosAnt = movimientosAnt.filter(m => m.tipo === 'Ingreso').reduce((s, m) => s + m.monto, 0);
                egresosAnt = movimientosAnt.filter(m => m.tipo === 'Egreso').reduce((s, m) => s + m.monto, 0);
            }

            // Actualizar cards principales
            document.getElementById('dineroDisponible').textContent = formatMoney(dineroDisponible);
            document.getElementById('porCobrar').textContent = formatMoney(porCobrar);
            document.getElementById('porPagar').textContent = formatMoney(porPagar);
            document.getElementById('capitalTotal').textContent = formatMoney(capitalTotal);

            // Actualizar cards de balance
            document.getElementById('balanceOperacional').textContent = formatMoney(balanceOperacional);
            document.getElementById('balanceGeneral').textContent = formatMoney(balanceGeneral);

            // Actualizar comparativas (usando ingresos operacionales)
            document.getElementById('ingresosActual').textContent = formatMoney(ingresosOperacionales);
            document.getElementById('egresosActual').textContent = formatMoney(egresosOperacionales);
            document.getElementById('balanceActual').textContent = formatMoney(balanceOperacional);

            if (periodoComp) {
                const cambioIng = calcularCambio(ingresosOperacionales, ingresosOpAnt);
                const cambioEgr = calcularCambio(egresosOperacionales, egresosOpAnt);
                const cambioBalance = calcularCambio(balanceOperacional, ingresosOpAnt - egresosOpAnt);

                document.getElementById('trendIngresos').innerHTML = `
                    <span class="${ingresosOperacionales >= ingresosOpAnt ? 'up' : 'down'}">
                        ${ingresosOperacionales >= ingresosOpAnt ? 'üìà' : 'üìâ'} ${cambioIng} vs per√≠odo comparaci√≥n
                    </span>
                `;
                document.getElementById('trendEgresos').innerHTML = `
                    <span class="${egresosOperacionales <= egresosOpAnt ? 'up' : 'down'}">
                        ${egresosOperacionales <= egresosOpAnt ? 'üìà' : 'üìâ'} ${cambioEgr} vs per√≠odo comparaci√≥n
                    </span>
                `;
                document.getElementById('trendBalance').innerHTML = `
                    <span class="${balanceOperacional >= (ingresosOpAnt - egresosOpAnt) ? 'up' : 'down'}">
                        ${balanceOperacional >= (ingresosOpAnt - egresosOpAnt) ? 'üìà' : 'üìâ'} ${cambioBalance} vs per√≠odo comparaci√≥n
                    </span>
                `;
            } else {
                document.getElementById('trendIngresos').textContent = '';
                document.getElementById('trendEgresos').textContent = '';
                document.getElementById('trendBalance').textContent = '';
            }

            // Promedio diario
            const rangoDates = obtenerRangoFechas(filtroActual, rangoPersonalizado);
            if (rangoDates) {
                const dias = Math.ceil((rangoDates.hasta - rangoDates.desde) / (1000 * 60 * 60 * 24)) + 1;
                const promedio = ingresosOperacionales / dias;
                document.getElementById('promedioDiario').textContent = formatMoney(promedio);
            } else {
                document.getElementById('promedioDiario').textContent = '-';
            }

            // Tabla resumen detallado
            const tbody = document.getElementById('resumenDetallado');
            if (movimientosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No hay movimientos en este per√≠odo</td></tr>';
            } else {
                let filas = `
                    <tr>
                        <td><strong>Ingresos Operacionales</strong></td>
                        <td class="ingreso">${formatMoney(ingresosOperacionales)}</td>
                        <td>${periodoComp ? formatMoney(ingresosOpAnt) : '-'}</td>
                        <td>${periodoComp ? calcularCambio(ingresosOperacionales, ingresosOpAnt) : '-'}</td>
                    </tr>`;
                
                if (aportesCapital > 0) {
                    filas += `
                    <tr style="background: #f0f8ff;">
                        <td><em>+ Aportes de Capital</em></td>
                        <td class="ingreso"><em>${formatMoney(aportesCapital)}</em></td>
                        <td>-</td>
                        <td>-</td>
                    </tr>`;
                }
                
                filas += `
                    <tr>
                        <td><strong>Egresos Operacionales</strong></td>
                        <td class="egreso">${formatMoney(egresosOperacionales)}</td>
                        <td>${periodoComp ? formatMoney(egresosOpAnt) : '-'}</td>
                        <td>${periodoComp ? calcularCambio(egresosOperacionales, egresosOpAnt) : '-'}</td>
                    </tr>`;
                
                if (retirosPersonales > 0) {
                    filas += `
                    <tr style="background: #fff5f5;">
                        <td><em>+ Gastos Personales y Retiros</em></td>
                        <td class="egreso"><em>${formatMoney(retirosPersonales)}</em></td>
                        <td>-</td>
                        <td>-</td>
                    </tr>`;
                }
                
                filas += `
                    <tr style="background: #e8f5e9;">
                        <td><strong>Balance Operacional</strong></td>
                        <td><strong>${formatMoney(balanceOperacional)}</strong></td>
                        <td>${periodoComp ? formatMoney(ingresosOpAnt - egresosOpAnt) : '-'}</td>
                        <td>${periodoComp ? calcularCambio(balanceOperacional, ingresosOpAnt - egresosOpAnt) : '-'}</td>
                    </tr>
                    <tr style="background: #f8f9fa;">
                        <td><strong>Balance General (con gastos personales)</strong></td>
                        <td><strong>${formatMoney(balanceGeneral)}</strong></td>
                        <td>${periodoComp ? formatMoney(ingresosAnt - egresosAnt) : '-'}</td>
                        <td>${periodoComp ? calcularCambio(balanceGeneral, ingresosAnt - egresosAnt) : '-'}</td>
                    </tr>`;
                
                tbody.innerHTML = filas;
            }

            // Crear gr√°fico de gastos personales vs ingresos
            crearGraficoGastosPersonales(ingresosOperacionales, retirosPersonales, balanceOperacional, balanceGeneral);
        }

        function actualizarGraficos() {
            // Categor√≠as que NO se consideran ingresos/egresos operacionales
            const categoriasCapital = ['Capital Inicial', 'Aporte Personal', 'Pr√©stamo Recibido'];
            const categoriasRetiros = ['Retiro Personal', 'Gastos Personales', 'Pago Pr√©stamo'];
            
            const movimientosFiltrados = filtrarPorFecha(datos.caja, filtroGraficos);
            
            let dineroDisponible = datos.caja.reduce((sum, m) => {
                return m.tipo === 'Ingreso' ? sum + m.monto : sum - m.monto;
            }, 0);

            let porCobrar = datos.cuentasPorCobrar.reduce((sum, c) => sum + c.saldoPendiente, 0);
            let porPagar = datos.cuentasPorPagar.reduce((sum, c) => sum + c.saldoPendiente, 0);
            let capitalTotal = dineroDisponible + porCobrar - porPagar;

            // Separar ingresos operacionales
            const ingresosOperacionales = movimientosFiltrados
                .filter(m => m.tipo === 'Ingreso' && !categoriasCapital.includes(m.categoria))
                .reduce((s, m) => s + m.monto, 0);
            
            const egresosOperacionales = movimientosFiltrados
                .filter(m => m.tipo === 'Egreso' && !categoriasRetiros.includes(m.categoria))
                .reduce((s, m) => s + m.monto, 0);

            // Gr√°fico de Distribuci√≥n de Capital
            crearGraficoCapital(dineroDisponible, porCobrar, porPagar);

            // Gr√°fico de Composici√≥n Financiera
            crearGraficoComposicion(dineroDisponible, porCobrar, porPagar, capitalTotal);

            // Gr√°fico de Ingresos por Categor√≠a
            crearGraficoIngresos(movimientosFiltrados);

            // Gr√°fico de Gastos por Categor√≠a (solo gastos operacionales)
            crearGraficoGastos(movimientosFiltrados, categoriasRetiros);

            // Gr√°fico de Ingresos vs Egresos (operacionales)
            crearGraficoIngresosEgresos(ingresosOperacionales, egresosOperacionales);

            // Gr√°fico de Evoluci√≥n Mensual
            crearGraficoEvolucion(categoriasCapital, categoriasRetiros);

            // Gr√°ficos de Estado de Cuentas
            crearGraficoCobrar();
            crearGraficoPagar();
        }

        function crearGraficoCapital(disponible, cobrar, pagar) {
            const ctx = document.getElementById('chartCapital');
            if (charts.capital) charts.capital.destroy();

            charts.capital = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Dinero Disponible', 'Por Cobrar', 'Por Pagar'],
                    datasets: [{
                        data: [disponible, cobrar, pagar],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(56, 239, 125, 0.8)',
                            'rgba(245, 87, 108, 0.8)'
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(56, 239, 125, 1)',
                            'rgba(245, 87, 108, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatMoney(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }

        function crearGraficoComposicion(disponible, cobrar, pagar, total) {
            const ctx = document.getElementById('chartComposicion');
            if (charts.composicion) charts.composicion.destroy();

            const porcentajes = [
                (disponible / total * 100).toFixed(1),
                (cobrar / total * 100).toFixed(1),
                (pagar / total * 100).toFixed(1)
            ];

            charts.composicion = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [
                        `Disponible (${porcentajes[0]}%)`,
                        `En la calle (${porcentajes[1]}%)`,
                        `Deudas (${porcentajes[2]}%)`
                    ],
                    datasets: [{
                        data: [disponible, cobrar, pagar],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(56, 239, 125, 0.8)',
                            'rgba(245, 87, 108, 0.8)'
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(56, 239, 125, 1)',
                            'rgba(245, 87, 108, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatMoney(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }

        function crearGraficoIngresos(movimientos) {
            const ctx = document.getElementById('chartIngresos');
            if (charts.ingresos) charts.ingresos.destroy();

            const ingresosPorCategoria = {};
            movimientos.filter(m => m.tipo === 'Ingreso').forEach(m => {
                ingresosPorCategoria[m.categoria] = (ingresosPorCategoria[m.categoria] || 0) + m.monto;
            });

            const categorias = Object.keys(ingresosPorCategoria);
            const valores = Object.values(ingresosPorCategoria);

            if (categorias.length === 0) {
                charts.ingresos = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Sin ingresos'],
                        datasets: [{
                            label: 'Ingresos',
                            data: [0],
                            backgroundColor: 'rgba(56, 239, 125, 0.3)',
                            borderColor: 'rgba(56, 239, 125, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                return;
            }

            charts.ingresos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categorias,
                    datasets: [{
                        label: 'Ingresos',
                        data: valores,
                        backgroundColor: 'rgba(56, 239, 125, 0.8)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatMoney(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatMoney(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function crearGraficoGastos(movimientos, categoriasRetiros) {
            const ctx = document.getElementById('chartGastos');
            if (charts.gastos) charts.gastos.destroy();

            const gastosPorCategoria = {};
            // Incluir TODOS los egresos, sin excluir nada
            movimientos.filter(m => m.tipo === 'Egreso').forEach(m => {
                gastosPorCategoria[m.categoria] = (gastosPorCategoria[m.categoria] || 0) + m.monto;
            });

            const categorias = Object.keys(gastosPorCategoria);
            const valores = Object.values(gastosPorCategoria);

            if (categorias.length === 0) {
                // Si no hay gastos, mostrar gr√°fico vac√≠o
                charts.gastos = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Sin gastos'],
                        datasets: [{
                            label: 'Gastos',
                            data: [0],
                            backgroundColor: 'rgba(245, 87, 108, 0.3)',
                            borderColor: 'rgba(245, 87, 108, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                return;
            }

            charts.gastos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categorias,
                    datasets: [{
                        label: 'Gastos',
                        data: valores,
                        backgroundColor: 'rgba(245, 87, 108, 0.8)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatMoney(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatMoney(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function crearGraficoIngresosEgresos(ingresos, egresos) {
            const ctx = document.getElementById('chartIngresosEgresos');
            if (charts.ingresosEgresos) charts.ingresosEgresos.destroy();

            charts.ingresosEgresos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Egresos', 'Balance'],
                    datasets: [{
                        label: 'Monto',
                        data: [ingresos, egresos, ingresos - egresos],
                        backgroundColor: [
                            'rgba(56, 239, 125, 0.8)',
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(102, 126, 234, 0.8)'
                        ],
                        borderColor: [
                            'rgba(56, 239, 125, 1)',
                            'rgba(245, 87, 108, 1)',
                            'rgba(102, 126, 234, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatMoney(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatMoney(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function crearGraficoEvolucion(categoriasCapital, categoriasRetiros) {
            const ctx = document.getElementById('chartEvolucion');
            if (charts.evolucion) charts.evolucion.destroy();

            // Obtener √∫ltimos 6 meses
            const hoy = new Date();
            const meses = [];
            const ingresosMensuales = [];
            const egresosMensuales = [];
            const balanceMensual = [];

            for (let i = 5; i >= 0; i--) {
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                const nombreMes = fecha.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
                meses.push(nombreMes);

                const movimientosMes = datos.caja.filter(m => {
                    const fechaMovimiento = new Date(m.fecha);
                    return fechaMovimiento.getFullYear() === fecha.getFullYear() &&
                           fechaMovimiento.getMonth() === fecha.getMonth();
                });

                // Solo contar ingresos y egresos operacionales
                const ingresos = movimientosMes
                    .filter(m => m.tipo === 'Ingreso' && !categoriasCapital.includes(m.categoria))
                    .reduce((s, m) => s + m.monto, 0);
                const egresos = movimientosMes
                    .filter(m => m.tipo === 'Egreso' && !categoriasRetiros.includes(m.categoria))
                    .reduce((s, m) => s + m.monto, 0);

                ingresosMensuales.push(ingresos);
                egresosMensuales.push(egresos);
                balanceMensual.push(ingresos - egresos);
            }

            charts.evolucion = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [
                        {
                            label: 'Ingresos Operacionales',
                            data: ingresosMensuales,
                            borderColor: 'rgba(56, 239, 125, 1)',
                            backgroundColor: 'rgba(56, 239, 125, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Egresos Operacionales',
                            data: egresosMensuales,
                            borderColor: 'rgba(245, 87, 108, 1)',
                            backgroundColor: 'rgba(245, 87, 108, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Balance Operacional',
                            data: balanceMensual,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatMoney(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatMoney(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function crearGraficoCobrar() {
            const ctx = document.getElementById('chartCobrar');
            if (charts.cobrar) charts.cobrar.destroy();

            const pagados = datos.cuentasPorCobrar.filter(c => c.saldoPendiente === 0).length;
            const pendientes = datos.cuentasPorCobrar.filter(c => c.saldoPendiente > 0).length;

            charts.cobrar = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pagadas', 'Pendientes'],
                    datasets: [{
                        data: [pagados, pendientes],
                        backgroundColor: [
                            'rgba(56, 239, 125, 0.8)',
                            'rgba(255, 193, 7, 0.8)'
                        ],
                        borderColor: [
                            'rgba(56, 239, 125, 1)',
                            'rgba(255, 193, 7, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw + ' clientes';
                                }
                            }
                        }
                    }
                }
            });
        }

        function crearGraficoPagar() {
            const ctx = document.getElementById('chartPagar');
            if (charts.pagar) charts.pagar.destroy();

            const pagados = datos.cuentasPorPagar.filter(c => c.saldoPendiente === 0).length;
            const pendientes = datos.cuentasPorPagar.filter(c => c.saldoPendiente > 0).length;

            charts.pagar = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pagadas', 'Pendientes'],
                    datasets: [{
                        data: [pagados, pendientes],
                        backgroundColor: [
                            'rgba(56, 239, 125, 0.8)',
                            'rgba(245, 87, 108, 0.8)'
                        ],
                        borderColor: [
                            'rgba(56, 239, 125, 1)',
                            'rgba(245, 87, 108, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw + ' proveedores';
                                }
                            }
                        }
                    }
                }
            });
        }

        function crearGraficoGastosPersonales(ingresos, gastosPersonales, balanceOp, balanceGen) {
            const ctx = document.getElementById('chartGastosPersonales');
            if (charts.gastosPersonales) charts.gastosPersonales.destroy();

            // Calcular porcentaje de gastos personales sobre ingresos
            const porcentaje = ingresos > 0 ? ((gastosPersonales / ingresos) * 100).toFixed(1) : 0;
            const disponibleDespuesGastos = Math.max(0, balanceOp - gastosPersonales);

            charts.gastosPersonales = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ingresos del Negocio', 'Gastos Personales', 'Balance Operacional', 'Balance General'],
                    datasets: [{
                        label: 'Monto',
                        data: [ingresos, gastosPersonales, balanceOp, balanceGen],
                        backgroundColor: [
                            'rgba(56, 239, 125, 0.8)',
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)'
                        ],
                        borderColor: [
                            'rgba(56, 239, 125, 1)',
                            'rgba(245, 87, 108, 1)',
                            'rgba(102, 126, 234, 1)',
                            'rgba(118, 75, 162, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = formatMoney(context.raw);
                                    if (context.dataIndex === 1 && ingresos > 0) {
                                        label += ` (${porcentaje}% de los ingresos)`;
                                    }
                                    return label;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: gastosPersonales > 0 ? `Gastas ${porcentaje}% de lo que produces en gastos personales` : 'Sin gastos personales registrados',
                            font: {
                                size: 14
                            },
                            color: gastosPersonales > balanceOp ? '#dc3545' : '#28a745'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatMoney(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function agregarMovimientoCaja(e) {
            e.preventDefault();
            
            const movimiento = {
                id: Date.now(),
                fecha: document.getElementById('cajafecha').value,
                tipo: document.getElementById('cajaTipo').value,
                monto: obtenerValorNumerico(document.getElementById('cajaMonto')),
                concepto: document.getElementById('cajaConcepto').value,
                categoria: document.getElementById('cajaCategoria').value,
                notas: document.getElementById('cajaNotas').value
            };

            datos.caja.unshift(movimiento);
            actualizarTablaCaja();
            actualizarDashboard();
            actualizarIngresos();
            actualizarGastos();
            actualizarHistorial();
            
            guardarAutomaticamente(); // Guardar en Google Sheets
            
            e.target.reset();
            document.getElementById('cajafecha').valueAsDate = new Date();
            alert('‚úÖ Movimiento agregado correctamente');
        }

        function actualizarTablaCaja() {
            const movimientosFiltrados = filtrarPorFecha(datos.caja, filtroCaja, rangoPersonalizadoCaja);
            const tbody = document.getElementById('tablaCaja');
            
            if (movimientosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No hay movimientos en este per√≠odo</td></tr>';
                return;
            }

            tbody.innerHTML = movimientosFiltrados.map(m => `
                <tr>
                    <td>${m.fecha}</td>
                    <td><span class="status-badge ${m.tipo === 'Ingreso' ? 'status-pagado' : 'status-pendiente'}">${m.tipo}</span></td>
                    <td>${m.concepto}</td>
                    <td>${m.categoria}</td>
                    <td class="${m.tipo === 'Ingreso' ? 'ingreso' : 'egreso'}">${formatMoney(m.monto)}</td>
                    <td>${m.notas || '-'}</td>
                    <td><button class="btn btn-danger" onclick="eliminarMovimiento(${m.id})">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        function eliminarMovimiento(id) {
            if (confirm('¬øSeguro que deseas eliminar este movimiento?')) {
                datos.caja = datos.caja.filter(m => m.id !== id);
                actualizarTablaCaja();
                actualizarDashboard();
                actualizarIngresos();
                actualizarGastos();
                actualizarHistorial();
                guardarAutomaticamente(); // Guardar en Google Sheets
            }
        }

        function agregarCuentaPorCobrar(e) {
            e.preventDefault();
            
            const totalDeuda = obtenerValorNumerico(document.getElementById('cobrarMonto'));
            
            const cuenta = {
                id: Date.now(),
                cliente: document.getElementById('cobrarCliente').value,
                telefono: document.getElementById('cobrarTelefono').value || '',
                fecha: document.getElementById('cobrarFecha').value,
                totalDeuda: totalDeuda,
                abonos: [],
                saldoPendiente: totalDeuda,
                notas: document.getElementById('cobrarNotas').value
            };

            datos.cuentasPorCobrar.push(cuenta);
            actualizarTablaCobrar();
            actualizarDashboard();
            
            guardarAutomaticamente(); // Guardar en Google Sheets
            
            e.target.reset();
            document.getElementById('cobrarFecha').valueAsDate = new Date();
            alert('‚úÖ Cliente agregado correctamente');
        }

        function actualizarTablaCobrar() {
            const tbody = document.getElementById('tablaCobrar');
            if (datos.cuentasPorCobrar.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No hay cuentas por cobrar</td></tr>';
                return;
            }

            tbody.innerHTML = datos.cuentasPorCobrar.map(c => `
                <tr>
                    <td><strong>${c.cliente}</strong></td>
                    <td>${c.telefono || '-'}</td>
                    <td>${c.fecha}</td>
                    <td>${formatMoney(c.totalDeuda)}</td>
                    <td>${c.abonos.map(a => `${formatMoney(a.monto)} (${a.fecha})`).join('<br>') || '-'}</td>
                    <td><strong>${formatMoney(c.saldoPendiente)}</strong></td>
                    <td><span class="status-badge ${c.saldoPendiente === 0 ? 'status-pagado' : 'status-pendiente'}">
                        ${c.saldoPendiente === 0 ? 'Pagado' : 'Pendiente'}
                    </span></td>
                    <td>${c.notas || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            ${c.saldoPendiente > 0 ? `<button class="btn btn-success" onclick="registrarAbono(${c.id}, 'cobrar')">üíµ Abono</button>` : ''}
                            ${c.saldoPendiente > 0 ? `<button class="btn btn-info" onclick="agregarMasCredito(${c.id})">‚ûï Cr√©dito</button>` : ''}
                            ${c.telefono ? `<a href="https://wa.me/57${c.telefono}?text=Hola%20${encodeURIComponent(c.cliente)},%20te%20recuerdo%20que%20tienes%20un%20saldo%20pendiente%20de%20${formatMoney(c.saldoPendiente).replace('$', '')}%20con%20Cruz%20Store.%20¬°Gracias!" class="btn-whatsapp" target="_blank">üì± Cobrar</a>` : ''}
                            <button class="btn btn-danger" onclick="eliminarCuenta(${c.id}, 'cobrar')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function agregarCuentaPorPagar(e) {
            e.preventDefault();
            
            const totalDeuda = obtenerValorNumerico(document.getElementById('pagarMonto'));
            
            const cuenta = {
                id: Date.now(),
                proveedor: document.getElementById('pagarProveedor').value,
                fecha: document.getElementById('pagarFecha').value,
                totalDeuda: totalDeuda,
                pagos: [],
                saldoPendiente: totalDeuda,
                notas: document.getElementById('pagarNotas').value
            };

            datos.cuentasPorPagar.push(cuenta);
            actualizarTablaPagar();
            actualizarDashboard();
            
            guardarAutomaticamente(); // Guardar en Google Sheets
            
            e.target.reset();
            document.getElementById('pagarFecha').valueAsDate = new Date();
            alert('‚úÖ Proveedor agregado correctamente');
        }

        function actualizarTablaPagar() {
            const tbody = document.getElementById('tablaPagar');
            if (datos.cuentasPorPagar.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No hay cuentas por pagar</td></tr>';
                return;
            }

            tbody.innerHTML = datos.cuentasPorPagar.map(c => `
                <tr>
                    <td><strong>${c.proveedor}</strong></td>
                    <td>${c.fecha}</td>
                    <td>${formatMoney(c.totalDeuda)}</td>
                    <td>${c.pagos.map(p => `${formatMoney(p.monto)} (${p.fecha})`).join('<br>') || '-'}</td>
                    <td><strong>${formatMoney(c.saldoPendiente)}</strong></td>
                    <td><span class="status-badge ${c.saldoPendiente === 0 ? 'status-pagado' : 'status-pendiente'}">
                        ${c.saldoPendiente === 0 ? 'Pagado' : 'Pendiente'}
                    </span></td>
                    <td>${c.notas || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            ${c.saldoPendiente > 0 ? `<button class="btn btn-success" onclick="registrarAbono(${c.id}, 'pagar')">üíµ Pagar</button>` : ''}
                            ${c.saldoPendiente > 0 ? `<button class="btn btn-info" onclick="agregarMasCredito(${c.id}, 'pagar')">‚ûï M√°s Cr√©dito</button>` : ''}
                            <button class="btn btn-danger" onclick="eliminarCuenta(${c.id}, 'pagar')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function registrarAbono(id, tipo) {
            const lista = tipo === 'cobrar' ? datos.cuentasPorCobrar : datos.cuentasPorPagar;
            const cuenta = lista.find(c => c.id === id);
            
            // Crear un prompt m√°s amigable con el saldo actual
            const mensaje = `Saldo pendiente: ${formatMoney(cuenta.saldoPendiente)}\n\n¬øCu√°nto se abon√≥/pag√≥?\n(Ingresa solo n√∫meros, por ejemplo: 50000)`;
            const monto = prompt(mensaje);
            
            if (!monto || monto.trim() === '') {
                return; // Usuario cancel√≥
            }
            
            // Limpiar y validar el monto
            const montoLimpio = monto.replace(/\D/g, '');
            if (montoLimpio === '' || parseInt(montoLimpio) <= 0) {
                alert('‚ùå Monto inv√°lido. Por favor ingresa solo n√∫meros.');
                return;
            }

            const fecha = prompt('Fecha del abono (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!fecha) return;

            const montoNum = parseInt(montoLimpio);
            if (montoNum > cuenta.saldoPendiente) {
                alert(`‚ùå El abono de ${formatMoney(montoNum)} no puede ser mayor al saldo pendiente de ${formatMoney(cuenta.saldoPendiente)}`);
                return;
            }

            const registro = tipo === 'cobrar' ? 'abonos' : 'pagos';
            cuenta[registro].push({ monto: montoNum, fecha });
            cuenta.saldoPendiente -= montoNum;

            // Registrar el abono/pago en caja
            if (tipo === 'cobrar') {
                // Cuando nos pagan, es un INGRESO
                const movimiento = {
                    id: Date.now(),
                    fecha: fecha,
                    tipo: 'Ingreso',
                    monto: montoNum,
                    concepto: `Abono de ${cuenta.cliente}`,
                    categoria: 'Ventas',
                    notas: `Abono a cuenta por cobrar - Saldo pendiente: ${formatMoney(cuenta.saldoPendiente)}`
                };
                datos.caja.unshift(movimiento);
                actualizarTablaCobrar();
            } else {
                // Cuando pagamos, es un EGRESO
                const movimiento = {
                    id: Date.now(),
                    fecha: fecha,
                    tipo: 'Egreso',
                    monto: montoNum,
                    concepto: `Pago a ${cuenta.proveedor}`,
                    categoria: 'Inventario',
                    notas: `Pago de cuenta por pagar - Saldo pendiente: ${formatMoney(cuenta.saldoPendiente)}`
                };
                datos.caja.unshift(movimiento);
                actualizarTablaPagar();
            }

            actualizarTablaCaja();
            actualizarDashboard();
            actualizarIngresos();
            actualizarGastos();
            actualizarHistorial();
            guardarAutomaticamente(); // Guardar en Google Sheets
            alert(`‚úÖ Abono de ${formatMoney(montoNum)} registrado correctamente\n\nNuevo saldo pendiente: ${formatMoney(cuenta.saldoPendiente)}`);
        }

        function agregarMasCredito(id, tipo = 'cobrar') {
            const lista = tipo === 'cobrar' ? datos.cuentasPorCobrar : datos.cuentasPorPagar;
            const cuenta = lista.find(c => c.id === id);
            const nombrePersona = tipo === 'cobrar' ? cuenta.cliente : cuenta.proveedor;
            const tipoPersona = tipo === 'cobrar' ? 'Cliente' : 'Proveedor';
            
            const mensaje = `${tipoPersona}: ${nombrePersona}\nDeuda actual: ${formatMoney(cuenta.totalDeuda)}\nSaldo pendiente: ${formatMoney(cuenta.saldoPendiente)}\n\n¬øCu√°nto cr√©dito adicional ${tipo === 'cobrar' ? 'se le dar√°' : 'te han dado'}?\n(Ingresa solo n√∫meros, por ejemplo: 100000)`;
            const monto = prompt(mensaje);
            
            if (!monto || monto.trim() === '') {
                return; // Usuario cancel√≥
            }
            
            // Limpiar y validar el monto
            const montoLimpio = monto.replace(/\D/g, '');
            if (montoLimpio === '' || parseInt(montoLimpio) <= 0) {
                alert('‚ùå Monto inv√°lido. Por favor ingresa solo n√∫meros.');
                return;
            }

            const fecha = prompt('Fecha del nuevo cr√©dito (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!fecha) return;

            const montoNum = parseInt(montoLimpio);

            cuenta.totalDeuda += montoNum;
            cuenta.saldoPendiente += montoNum;

            if (tipo === 'cobrar') {
                actualizarTablaCobrar();
            } else {
                actualizarTablaPagar();
            }
            actualizarDashboard();
            guardarAutomaticamente(); // Guardar en Google Sheets
            alert(`‚úÖ Se agreg√≥ ${formatMoney(montoNum)} al cr√©dito ${tipo === 'cobrar' ? 'de' : 'con'} ${nombrePersona}\n\nNueva deuda total: ${formatMoney(cuenta.totalDeuda)}\nSaldo pendiente: ${formatMoney(cuenta.saldoPendiente)}`);
        }

        function eliminarCuenta(id, tipo) {
            if (confirm('¬øSeguro que deseas eliminar esta cuenta?')) {
                if (tipo === 'cobrar') {
                    datos.cuentasPorCobrar = datos.cuentasPorCobrar.filter(c => c.id !== id);
                    actualizarTablaCobrar();
                } else {
                    datos.cuentasPorPagar = datos.cuentasPorPagar.filter(c => c.id !== id);
                    actualizarTablaPagar();
                }
                actualizarDashboard();
                guardarAutomaticamente(); // Guardar en Google Sheets
            }
        }

        function actualizarGastos() {
            // Mostrar TODOS los egresos, incluyendo gastos personales
            const movimientosFiltrados = filtrarPorFecha(
                datos.caja.filter(m => m.tipo === 'Egreso'), 
                filtroGastos
            );
            const gastos = {};
            let totalGastos = 0;

            movimientosFiltrados.forEach(m => {
                gastos[m.categoria] = (gastos[m.categoria] || 0) + m.monto;
                totalGastos += m.monto;
            });

            const tbody = document.getElementById('tablaGastos');
            if (Object.keys(gastos).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No hay gastos registrados en este per√≠odo</td></tr>';
                return;
            }

            tbody.innerHTML = Object.entries(gastos)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, total]) => `
                    <tr>
                        <td><strong>${cat}</strong></td>
                        <td class="egreso">${formatMoney(total)}</td>
                        <td>${((total / totalGastos) * 100).toFixed(1)}%</td>
                    </tr>
                `).join('') + `
                    <tr style="background: #f8f9fa;">
                        <td><strong>TOTAL GASTOS</strong></td>
                        <td class="egreso"><strong>${formatMoney(totalGastos)}</strong></td>
                        <td><strong>100%</strong></td>
                    </tr>
                `;
        }

        function actualizarIngresos() {
            // Mostrar TODOS los ingresos por categor√≠a
            const movimientosFiltrados = filtrarPorFecha(
                datos.caja.filter(m => m.tipo === 'Ingreso'), 
                filtroIngresos
            );
            const ingresos = {};
            let totalIngresos = 0;

            movimientosFiltrados.forEach(m => {
                ingresos[m.categoria] = (ingresos[m.categoria] || 0) + m.monto;
                totalIngresos += m.monto;
            });

            const tbody = document.getElementById('tablaIngresos');
            if (Object.keys(ingresos).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No hay ingresos registrados en este per√≠odo</td></tr>';
                return;
            }

            tbody.innerHTML = Object.entries(ingresos)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, total]) => `
                    <tr>
                        <td><strong>${cat}</strong></td>
                        <td class="ingreso">${formatMoney(total)}</td>
                        <td>${((total / totalIngresos) * 100).toFixed(1)}%</td>
                    </tr>
                `).join('') + `
                    <tr style="background: #f8f9fa;">
                        <td><strong>TOTAL INGRESOS</strong></td>
                        <td class="ingreso"><strong>${formatMoney(totalIngresos)}</strong></td>
                        <td><strong>100%</strong></td>
                    </tr>
                `;
        }

        function actualizarHistorial() {
            const movimientosFiltrados = filtrarPorFecha(datos.caja, filtroHistorial, rangoPersonalizadoHistorial);
            const tbody = document.getElementById('tablaHistorial');
            
            if (movimientosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No hay movimientos en este per√≠odo</td></tr>';
                return;
            }

            tbody.innerHTML = movimientosFiltrados.map(m => `
                <tr>
                    <td>${m.fecha}</td>
                    <td><span class="status-badge ${m.tipo === 'Ingreso' ? 'status-pagado' : 'status-pendiente'}">${m.tipo}</span></td>
                    <td>${m.concepto}</td>
                    <td class="${m.tipo === 'Ingreso' ? 'ingreso' : 'egreso'}">${formatMoney(m.monto)}</td>
                    <td>${m.categoria}</td>
                    <td>${m.notas || '-'}</td>
                </tr>
            `).join('');
        }

        // Inicializar
        actualizarDashboard();
        actualizarIngresos();
        actualizarGastos();
        actualizarGraficos();
    </script>
</body>
</html>
